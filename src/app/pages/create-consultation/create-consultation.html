<div class="consultation-container">
  <h2>Nueva Consulta</h2>

  <form [formGroup]="consultationForm" (ngSubmit)="onSubmit()">
    
    <!-- Información básica -->
    <section class="form-section">
      <h3>Información de la consulta</h3>
      
      <div class="form-group">
        <label for="reason">Motivo de consulta *</label>
        <textarea 
          id="reason" 
          formControlName="reason" 
          rows="3"
          placeholder="Ej: Evaluación nutricional completa"
          class="form-control">
        </textarea>
      </div>
    </section>

    <!-- Notas clínicas -->
    <section class="form-section">
      <h3>Notas clínicas</h3>
      
      <div formArrayName="notes">
        @for (note of notes.controls; track $index; let i = $index) {
          <div [formGroupName]="i" class="note-item">
            <div class="form-group">
              <label>Categoría</label>
              <select formControlName="categoryId" class="form-control">
                @for (category of noteCategories; track category.id) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </div>
            
            <div class="form-group">
              <label>Descripción</label>
              <textarea 
                formControlName="description" 
                rows="2"
                placeholder="Escribe tu nota aquí..."
                class="form-control">
              </textarea>
            </div>
            
            <button 
              type="button" 
              class="btn-remove" 
              (click)="removeNote(i)"
              [disabled]="notes.length === 1">
              Eliminar nota
            </button>
          </div>
        }
      </div>
      
      <button type="button" class="btn-add" (click)="addNote()">
        + Agregar nota
      </button>
    </section>

    <!-- Métricas antropométricas -->
    <section class="form-section">
      <h3>Mediciones antropométricas</h3>
      
      <div formArrayName="metricValues" class="metrics-grid">
        @for (metricControl of metricValues.controls; track $index; let i = $index) {
          <div [formGroupName]="i" class="metric-item">
            <label>{{ getMetricName(metricControl.value.metricsCatalogId) }}</label>
            <input 
              type="number" 
              step="0.1"
              formControlName="value" 
              placeholder="0.0"
              class="form-control">
          </div>
        }
      </div>
    </section>

    <!-- Gasto energético -->
    <section class="form-section" formGroupName="energeticExpenditure">
      <h3>Gasto energético</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label>Nivel de actividad física</label>
          <select formControlName="physicalActivityId" class="form-control">
            @for (activity of physicalActivities; track activity.id) {
              <option [value]="activity.id">
                {{ activity.name }} ({{ activity.description }})
              </option>
            }
          </select>
        </div>
        
        <div class="form-group">
          <label>Porcentaje de reducción calórica (%)</label>
          <input 
            type="number" 
            formControlName="reductionPercentage" 
            min="0" 
            max="100"
            placeholder="15"
            class="form-control">
        </div>
      </div>
    </section>

    <!-- Error message -->
    @if (errorMessage) {
      <div class="alert alert-error">
        {{ errorMessage }}
      </div>
    }

    <!-- Botones de acción -->
    <div class="form-actions">
      <button 
        type="button" 
        class="btn btn-secondary"
        routerLink="/dashboard">
        Cancelar
      </button>
      
      <button 
        type="submit" 
        class="btn btn-primary"
        [disabled]="isSubmitting || consultationForm.invalid">
        {{ isSubmitting ? 'Guardando...' : 'Guardar consulta' }}
      </button>
    </div>
  </form>

  <!-- Resultados calculados -->
  @if (calculatedIndicators.length > 0) {
    <section class="results-section">
      <h3>Resultados calculados</h3>
      
      <!-- Indicadores de salud -->
      <div class="indicators-grid">
        @for (indicator of calculatedIndicators; track indicator.typeIndicatorId) {
          <div class="indicator-card" [style.border-left-color]="indicator.color">
            <h4>{{ getIndicatorName(indicator.typeIndicatorId) }}</h4>
            <p class="value">{{ indicator.value }}</p>
            <span class="range" [style.color]="indicator.color">
              {{ indicator.rangeName }}
            </span>
          </div>
        }
      </div>
      
      <!-- Métricas calculadas -->
      <div class="metrics-calculated">
        <h4>Métricas calculadas</h4>
        <ul>
          @for (metric of calculatedMetrics; track metric.catalogId) {
            <li>
              <strong>{{ getMetricName(metric.catalogId) }}:</strong> 
              {{ metric.value }}
            </li>
          }
        </ul>
      </div>
    </section>
  }
</div>
